---
title: "Production trends"
author: "Richard Cottrell"
date: "10 May 2019"
output: html_document
---

#libraries
```{r}
library(data.table) 
library(ggpubr)
library(ggsci)
library(tidyverse)
library(wesanderson)
library(RColorBrewer)
```

#FED SPP LIST
```{r}

fed_spp <- 
  fread("fed_spp.csv", header=T)%>%
  rename(Species="Name_en") %>% 
  group_by(Species) %>%
  mutate(id = row_number()) 



positions <- c(4:18)

all_spp <- 
  fread("all_spp.csv", header=T) %>% 
  rename(Species = "Name_en")%>% 
  filter(!(Species %in% fed_spp$Species))


  

```

#Production data
```{r}

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information





(fed_aqua_prod <- 
  fread("aquaculture-prod-raw.csv", header=T) %>% 
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")%>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) %>% 
  mutate(Year = gsub("X", "", Year) %>% 
           as.numeric) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) %>% 
  filter(!(Value=="..." | Value=="" | Country=="Totals")) %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric) %>%
  select(-Unit) %>% 
  group_by(Country, Species, Area, Year, Environment) %>%
  mutate(id= row_number()) %>% 
  filter(Species %in% fed_spp$Species) %>% 
  left_join(.,fed_spp, by=c("Species", "id"))%>% 
  mutate(Taxa_adj = case_when(Taxa %in% c("Smelts") ~ "Other",
                              Taxa %in% c("Flatfishes","Marine fishes","Cods") ~ "Marine fishes",
                              Species %in% c("Flathead grey mullet" ,"Squaretail mullet",  "So-iuy mullet", "Lebranche mullet" )~ "Mullets",
                              Taxa == "Shrimps" ~ "Shrimps",
                              Taxa == "Carps" ~ "Carps",
                              Taxa == "FW fishes" ~ "FW fishes",
                              Taxa == "FW crustaceans" ~ "FW crustaceans",
                              Taxa == "Marine crustaceans" ~ "Other",
                              Taxa == "Diadromous fishes" ~ "Diadromous fishes",
                              Species=="Milkfish" ~ "Milkfish",
                              Taxa == "Tilapias" ~ "Tilapias",
                              Taxa == "Eels" ~ "Other",
                              Taxa == "Shads" ~ "Other",
                              Taxa == "Tunas" ~ "Other",
                              T ~ Taxa)) %>% 
   select(Country, Species, Area, Environment, Year, Value, Group, ISSCAAP_Group) %>% 
   mutate(Group = case_when(Group == "PISCES" ~ "Fed Finfish",
                            Group == "CRUSTACEA" ~ "Fed Crustaceans"))
   
)



(unfed_aqua_prod <- 
  fread("aquaculture-prod-raw.csv", header=T) %>% 
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")%>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) %>% 
  mutate(Year = gsub("X", "", Year) %>% 
           as.numeric) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) %>% 
  filter(!(Value=="..." | Value==""| Country=="Totals")) %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric) %>%
  select(-Unit) %>% 
  group_by(Country, Species, Area, Year, Environment) %>%
  mutate(id= row_number()) %>% 
  filter(!(Species %in% fed_spp$Species)) %>% 
  left_join(all_spp, by="Species") %>% 
  select(Country, Species, Area, Environment, Year, Value, Major_Group, ISSCAAP_Group) %>% 
  mutate(ISSCAAP_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "Green seaweeds",
                                   Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "Bacteria",
                                   Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "Carps, barbels and other cyprinids",
                                   Species == "[Sargassum spp]" ~ "Brown seaweeds",
                                   Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                  "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                  "[Channa marulius]", "[Labeo dussumieri]",
                                                  "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                  "[Leporinus spp]", "[Leporinus obtusidens]",
                                                  "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                  "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "Miscellaneous freshwater fishes",
                                   Species == "[Solea spp]" ~ "Miscellaneous demersal fishes" ,
                                   Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "Red seaweeds",
                                   TRUE ~ ISSCAAP_Group)) %>% 
  mutate(Major_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "PROKARYOTA",
                                 Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "UNFED PISCES",
                                 Species == "[Sargassum spp]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                "[Channa marulius]", "[Labeo dussumieri]",
                                                "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                "[Leporinus spp]", "[Leporinus obtusidens]",
                                                "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "UNFED PISCES",
                                 Species == "[Solea spp]" ~ "UNFED PISCES" ,
                                 Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "UNFED PISCES",
                                 Major_Group =="PISCES" ~ "UNFED PISCES",
                                 TRUE ~ Major_Group)) %>% 
    rename(Group = Major_Group) %>% 
    mutate(Group = case_when(Group == "UNFED PISCES" ~ "Unfed finfish",
                             Group == "MOLLUSCA" ~ "Molluscs",
                             Group == "AMPHIBIA, REPTILIA" ~ "Amphibians & reptiles",
                             Group == "PLANTAE AQUATICAE" ~ "Aquatic plants",
                             Group == "PROKARYOTA" ~ "Bacteria",
                             Group == "INVERTEBRATA AQUATICA" ~ "Other aquatic invertebrates",
                             Group == "CRUSTACEA" ~ "Unfed crustaceans" ))
  )                           



(total_aqua_prod <-
    bind_rows(
      fed_aqua_prod, unfed_aqua_prod
    ) %>% 
    group_by(Group, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    filter(Group!="Unfed crustaceans") %>% 
    ungroup() %>% 
    mutate(Group = factor(Group, levels=c("Aquatic plants", "Molluscs", "Bacteria", "Amphibians & reptiles", "Other aquatic invertebrates","Unfed finfish","Fed Crustaceans" , "Fed Finfish"))) %>% 
    ggplot(aes(x=Year, y=Value)) + 
    geom_area(aes(fill=Group))+
    #scale_x_continuous(limits=c(1960,2020))+
    scale_y_continuous(labels = c(0, 25, 50, 75, 100))+
    labs(y=bquote(Biomass~(million~tonnes)))+
    theme_pubr()+
    theme(
      legend.position = c(0.4, 0.85),
      legend.title = element_blank(),
      text = element_text(size=8),
      legend.text = element_text(size=7),
      legend.key.size = unit(0.4, "cm")
    )+
    scale_fill_manual(values = brewer.pal(name="Spectral", n=8))+
    guides(fill= guide_legend(ncol=2))
)+
  ggsave("Production trends.tiff", device = "tiff", dpi=300, width=10, height = 7.5, units = "cm")+
  ggsave("Production trends.pdf", device = "pdf", dpi=300, width=10, height = 7.5, units = "cm")



unique((bind_rows(
      fed_aqua_prod, unfed_aqua_prod
    ) %>% 
    group_by(Group, Year) %>% 
    summarise(Value=sum(Value)) %>% 
  arrange(-Value))$Group)
```