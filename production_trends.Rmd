---
title: "Production trends"
author: "Richard Cottrell"
date: "10 May 2019"
output: html_document
---

#libraries
```{r}
library(devtools)
#devtools::install_github("johannesbjork/LaCroixColoR")
#remotes::install_github("ropensci/rfishbase")
library(taxize)
library(rfishbase)
library(data.table) 
library(mgcv)
library(ggpubr)
library(ggsci)
library(purrr)
library(broom)
library(tidyverse)
library(RColorBrewer)
library(LaCroixColoR)
```

#FED SPP LIST
```{r} 

fed_spp <- 
  fread("fed_spp.csv", header=T)%>%
  rename(Species="Name_en") %>% 
  group_by(Species) %>%
  mutate(id = row_number()) 



positions <- c(4:18)

all_spp <- 
  fread("all_spp.csv", header=T) %>% 
  rename(Species = "Name_en")%>% 
  filter(!(Species %in% fed_spp$Species))


  

```

#Production data
```{r}

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information





(fed_aqua_prod <- 
  fread("aqua-prod-raw.csv", header=T) %>% 
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")%>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) %>% 
  mutate(Year = gsub("X", "", Year) %>% 
           as.numeric) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) %>% 
  filter(!(Value=="..." | Value=="" | Country=="Totals")) %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric) %>%
  select(-Unit) %>% 
  group_by(Country, Species, Area, Year, Environment) %>%
  mutate(id= row_number()) %>% 
  filter(Species %in% fed_spp$Species) %>% 
  left_join(.,fed_spp, by=c("Species", "id"))%>% 
  mutate(Taxa_adj = case_when(Taxa %in% c("Smelts") ~ "Other",
                              Taxa %in% c("Flatfishes","Marine fishes","Cods") ~ "Marine fishes",
                              Species %in% c("Flathead grey mullet" ,"Squaretail mullet",  "So-iuy mullet", "Lebranche mullet" )~ "Mullets",
                              Taxa == "Shrimps" ~ "Shrimps",
                              Taxa == "Carps" ~ "Carps",
                              Taxa == "FW fishes" ~ "FW fishes",
                              Taxa == "FW crustaceans" ~ "FW crustaceans",
                              Taxa == "Marine crustaceans" ~ "Other",
                              Taxa == "Diadromous fishes" ~ "Diadromous fishes",
                              Species=="Milkfish" ~ "Milkfish",
                              Taxa == "Tilapias" ~ "Tilapias",
                              Taxa == "Eels" ~ "Other",
                              Taxa == "Shads" ~ "Other",
                              Taxa == "Tunas" ~ "Other",
                              T ~ Taxa)) %>% 
   select(Country, Species, Area, Environment, Year, Value, Group, ISSCAAP_Group, Taxa_adj) %>% 
   mutate(Group = case_when(Group == "PISCES" ~ "Fed Finfish",
                            Group == "CRUSTACEA" ~ "Fed Crustaceans")) %>% 
   filter(Species!="Silver carp")
   
)



(unfed_aqua_prod <- 
  fread("aqua-prod-raw.csv", header=T) %>% 
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")%>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) %>% 
  mutate(Year = gsub("X", "", Year) %>% 
           as.numeric) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) %>% 
  filter(!(Value=="..." | Value==""| Country=="Totals")) %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric) %>%
  select(-Unit) %>% 
  group_by(Country, Species, Area, Year, Environment) %>%
  mutate(id= row_number()) %>% 
  filter(!(Species %in% fed_spp$Species)) %>% 
  left_join(all_spp, by="Species") %>% 
  select(Country, Species, Area, Environment, Year, Value, Major_Group, ISSCAAP_Group) %>% 
  mutate(ISSCAAP_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "Green seaweeds",
                                   Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "Bacteria",
                                   Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "Carps, barbels and other cyprinids",
                                   Species == "[Sargassum spp]" ~ "Brown seaweeds",
                                   Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                  "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                  "[Channa marulius]", "[Labeo dussumieri]",
                                                  "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                  "[Leporinus spp]", "[Leporinus obtusidens]",
                                                  "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                  "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "Miscellaneous freshwater fishes",
                                   Species == "[Solea spp]" ~ "Miscellaneous demersal fishes" ,
                                   Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "Red seaweeds",
                                   TRUE ~ ISSCAAP_Group)) %>% 
  mutate(Major_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "PROKARYOTA",
                                 Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "UNFED PISCES",
                                 Species == "[Sargassum spp]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                "[Channa marulius]", "[Labeo dussumieri]",
                                                "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                "[Leporinus spp]", "[Leporinus obtusidens]",
                                                "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "UNFED PISCES",
                                 Species == "[Solea spp]" ~ "UNFED PISCES" ,
                                 Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "UNFED PISCES",
                                 Major_Group =="PISCES" ~ "UNFED PISCES",
                                 TRUE ~ Major_Group)) %>% 
    rename(Group = Major_Group) %>% 
    mutate(Group = case_when(Group == "UNFED PISCES" ~ "Unfed finfish",
                             Group == "MOLLUSCA" ~ "Molluscs",
                             Group == "AMPHIBIA, REPTILIA" ~ "Amphibians & reptiles",
                             Group == "PLANTAE AQUATICAE" ~ "Aquatic plants",
                             Group == "PROKARYOTA" ~ "Bacteria",
                             Group == "INVERTEBRATA AQUATICA" ~ "Other aquatic invertebrates",
                             Group == "CRUSTACEA" ~ "Unfed crustaceans" ))
  )                           



(total_aqua_prod <-
    bind_rows(
      fed_aqua_prod, unfed_aqua_prod
    ) %>% 
    group_by(Group, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    filter(Group!="Unfed crustaceans") %>% 
    ungroup() %>% 
    mutate(Group = factor(Group, levels=c("Aquatic plants", "Molluscs", "Bacteria", "Amphibians & reptiles", "Other aquatic invertebrates","Unfed finfish","Fed Crustaceans" , "Fed Finfish"))) %>% 
    ggplot(aes(x=Year, y=Value)) + 
    geom_area(aes(fill=Group))+
    scale_x_continuous(limits=c(1995,2017))+
    scale_y_continuous(labels = c(0, 25, 50, 75, 100), breaks = c(0,25e+6, 50e+6, 75e+6, 100e+6))+
    labs(y=bquote(Biomass~(million~tonnes)), fill="All taxa")+
    theme_pubr()+
    theme(
      legend.position = c(0.45, 0.85),
      legend.title = element_text(size = 7, face="bold"),
      text = element_text(size=8),
      legend.text = element_text(size=7),
      legend.key.size = unit(0.4, "cm"),
      legend.background = element_rect(fill="transparent")
    )+
    scale_fill_manual(values = lacroix_palette("Tangerine", n=8))+
    guides(fill= guide_legend(ncol=2))
)+
  ggsave("Production trends.tiff", device = "tiff", dpi=300, width=10, height = 7.5, units = "cm")+
  ggsave("Production trends.pdf", device = "pdf", dpi=300, width=10, height = 7.5, units = "cm")

sort(unique(fed_aqua_prod$Species))

unique((bind_rows(
      fed_aqua_prod, unfed_aqua_prod
    ) %>% 
    group_by(Group, Year) %>% 
    summarise(Value=sum(Value)) %>% 
  arrange(-Value))$Group)
```

#Fed species by biomass 

```{r} 

fed_prod <- 
  fed_aqua_prod %>% 
  group_by(Taxa_adj, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  ggplot(aes(x=Year, y=Value, fill=Taxa_adj))+
  geom_area()+
  scale_x_continuous(limits = c(1995,2017))+
  scale_fill_manual(values = lacroix_palette("Lemon", n=11))+
  labs(y=bquote(Biomass~(million~tonnes)), fill="Fed species")+
    theme_pubr()+
    theme(
      legend.position = c(0.3, 0.76),
      legend.title = element_text(size = 7, face="bold"),
      text = element_text(size=8),
      legend.text = element_text(size=7),
      legend.key.size = unit(0.4, "cm"),
      legend.background = element_rect(fill="transparent")
    )+
  scale_y_continuous(labels = c(0,10,20,30,40,50))+
    guides(fill= guide_legend(ncol=2))+
  ggsave("Fed production trends.tiff", device = "tiff", dpi=300, width=10, height = 7.5, units = "cm")+
  ggsave("Fed production trends.pdf", device = "pdf", dpi=300, width=10, height = 7.5, units = "cm")

lacroix_palettes


ggarrange(total_aqua_prod, fed_prod, 
          labels = c("a", "b"),
          font.label = list(size=9))+
  ggsave("Production trends a b.tiff", device = "tiff", dpi=300, width=18, height = 7, units = "cm")+
  ggsave("Production trends a b.pdf", device = "pdf", dpi=300, width=18, height = 7, units = "cm")


```


#trophic levels of different groups

```{r}

fed_aqua_prod_2 <- 
  fed_aqua_prod %>% 
  rename(Taxa=Taxa_adj) %>% 
  mutate(Taxa=case_when(grepl("eel", Species)~"Eels",
                        TRUE~Taxa)) %>% 
  filter(Year>1994) %>% 
  mutate(Taxa = case_when(Species == "Milkfish" ~ "Milkfish",
                          ISSCAAP_Group == "Tunas, bonitos, billfishes" ~ "Marine fishes",
                          ISSCAAP_Group %in% c("Miscellaneous diadromous fishes", "Sturgeons, paddlefishes")~"FW fishes",
                          TRUE ~ Taxa)) 
  


#bring in the rendered animal by products from Pahlow
(by_products <- 
    fread("diets_pahlow.csv", header = TRUE) %>% 
    group_by(Taxa) %>% 
    summarise(Rendered_animal_prop = mean(Prop)) %>% 
    mutate(Year=2015))



#MODEL the change in forage fish over all years

(delta_forage_fish <- fread("forage_fish_diets.csv", header=TRUE) %>% 
    filter(Year!=2020) %>% 
    left_join(by_products, by=c("Taxa", "Year")) %>% 
    mutate(FMFO=Total/100) %>% 
    group_by(Taxa) %>%
    nest() %>% 
    mutate(FF_model = map(data, ~(gam(FMFO~s(Year), data = .))))
  )


year_range <- data_frame(Year=seq(1995,2015))
FF_models <- (delta_forage_fish$FF_model)


(feed_change <- data_frame(Taxa = rep(unique(forage_fish$Taxa), each=length(seq(1995,2015)), n=1),
                           Year = rep(seq(1995, 2015), length(unique(forage_fish$Taxa))),
                           delta_ff = unlist(lapply(FF_models, function(each_model){
                             fitted <- predict(each_model, type="response", newdata = year_range)
                             return(fitted)
                           })))
)


ggplot(feed_change, aes(Year, delta_ff, colour=Taxa))+geom_line()



```


(forage_fish <- fread("forage_fish_diets.csv", header=TRUE) %>% 
    filter(Year!=2020) %>% 
    mutate(Feeds_used = Feeds_used*1000,
           Prop=Total/100,
           TL_fish = 2.5,
           TL_crops = 1,
           Qi_FMFO = Feeds_used*Prop,
           Qi_Crops = Feeds_used-Qi_FMFO, 
           Qi_TL_Total = (TL_fish*Qi_FMFO) + (TL_crops*Qi_Crops),
           Taxa_TL = 1+(Qi_TL_Total/Feeds_used)) %>% 
  group_by(Taxa) %>% 
  nest() %>% 
  mutate(TL_model = map(data, ~((mgcv::gam(Taxa_TL~s(Year), data = .))))))
  







fish_models <- unique(forage_fish$TL_model)
feed_models <- unique(forage_fish$feeds_model)
new_years <- data_frame(Year=seq(1995,2015))

# predict(fish_models[[2]], type = "response", newdata = new_years)
# predict(feed_models[[1]], type = "response", newdata = new_years)
# 
# forage_fish$Feeds_used[1:16]

(TLs <- data_frame(Taxa = rep(unique(forage_fish$Taxa), each=length(seq(1995,2015)), n=1),
                   Year = rep(seq(1995, 2015), length(unique(forage_fish$Taxa))),
                   Farmed = unlist(lapply(fish_models, function(model){ 
                     fitted <- predict(model, type="response", new_years) 
                     return(fitted)}))
                   )
)



#Taxa species lists

(salmons <- common_to_sci(c("Atlantic salmon", "Coho salmon", "Chinook salmon")) %>% slice(1,4,5))
(trouts <- rfishbase::common_to_sci(c("Rainbow trout", "Clearhead icefish")) %>% slice(2,3))
carps <- rfishbase::common_to_sci("Grass carp", "Common carp")$Species
(tilapias <- rfishbase::common_to_sci("Nile tilapia"))
(catfishes <- rfishbase::common_to_sci(c("Pangas", "Amur catfish", "Channel catfish", "Yellow catfish", "Flathead catfish"))) %>% arrange(Species)
(marine_fishes <- rfishbase::common_to_sci(c("Amberjack" ,"European seabass")) %>% slice(3,34))
(fw_fishes <- rfishbase::common_to_sci(c("Snakehead", "Largemouth black bass")))
(eels <- rfishbase::common_to_sci(c("Asian swamp eel", "Japanese eel")))
(shrimps <- common_to_sci(c("Whiteleg shrimp", "Fleshy prawn", "Banana prawn", "Giant tiger prawn", "Kuruma prawn"),  server = "sealifebase") %>% slice(1,2,3,6,8))
(fw_crusts <- common_to_sci(c("Chinese mitten crab", "Red swamp crawfish", "Oriental river prawn", "Giant river prawn"),  server = "sealifebase") %>% 
    drop_na(Species))


(Fishbase_TLs <- 
    bind_rows(
      
      (Salmons <-  ecology(salmons$Species) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Salmons")),
      
      
      (Trouts <- rfishbase::ecology(trouts$Species) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Trouts")),
      
      
      (Carps <- rfishbase::ecology(carps) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Carps")),
      
      
      
      (Tilapias <- rfishbase::ecology(tilapias$Species) %>% 
         select(Species,DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Tilapias")),
      
      
      (Catfishes <- rfishbase::ecology(catfishes$Species) %>% 
         select(Species, DietTroph,  FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Catfishes")),
      
      
      (Milkfish <- rfishbase::ecology("Chanos chanos") %>% 
         select(Species, DietTroph,  FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Milkfish")),
      
      
      
      (Marine_fishes <- ecology(marine_fishes$Species) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa="Marine fishes")),
      
      
      (FW_fishes <- rfishbase::ecology(fw_fishes$Species) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
         mutate(Spp = case_when(grepl("hanna", Species) ~ "Snakehead", 
                                TRUE ~ "Blackmouth bass"),
                FoodTroph = as.numeric(FoodTroph)) %>% 
         group_by(Spp) %>% 
         summarise(FoodTroph=mean(FoodTroph)) %>% 
         mutate(DietTroph = c(3.84, 4.44),
                Species=Spp) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         mutate(DietTroph = as.character(DietTroph),
                FoodTroph = as.character(FoodTroph)) %>% 
         mutate(Taxa = "FW fishes")),
      
      (Eels <- rfishbase::ecology(eels$Species) %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         mutate(Taxa="Eels")),
      
      
      (Shrimps <- rfishbase::ecology(shrimps$Species, server = "sealifebase") %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa = "Shrimps")),
      
      
      
      (FW_crusts <- ecology(fw_crusts$Species, server = "sealifebase") %>% 
         select(Species, DietTroph, FoodTroph) %>% 
         filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>% 
         mutate(Taxa = "FW crustaceans"))
    ) %>% 
    mutate(TL_final = case_when(!is.na(DietTroph)~ DietTroph,
                                TRUE ~ FoodTroph),
           TL_final = as.numeric(TL_final)) %>% 
    group_by(Taxa) %>% 
    summarise(Fishbase =mean(TL_final))
)


fed_aqua_prod_2 %>% 
  filter(Taxa=="Eels", Year==2013) %>% 
  group_by(Species) %>% 
  summarise(Value=sum(Value)) %>% 
  arrange(-Value)



TLs %>% 
  left_join(Fishbase_TLs) %>% 
  gather(key = Production_type, value = "Trophic level", -c(Taxa, Year)) %>% 
   mutate(Taxa = factor(Taxa, levels = c("Salmons", "Trouts", "Marine fishes", "Shrimps", "Eels", "FW fishes", "Milkfish", "FW crustaceans", "Catfishes", "Tilapias", "Carps"))) %>% 
  ggplot(aes(x=Year, y=`Trophic level`, colour= Production_type, linetype=Production_type))+
  geom_line()+
  facet_wrap(~Taxa) +
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.position = "right", 
        legend.direction = "vertical",
        legend.title = element_blank())+
  scale_color_manual(values = c("grey20", "dodgerblue3"))+
  ggsave("Fishbase_v_calculated.tiff", device = "tiff", dpi = 300, width=18, height = 12, units = "cm")
  

TLs %>%
  mutate(Taxa = factor(Taxa, levels = c("Salmons", "Trouts", "Marine fishes", "Shrimps", "Eels", "FW fishes", "Milkfish", "FW crustaceans", "Catfishes", "Tilapias", "Carps"))) %>% 
  ggplot(aes(x=Year, y=Farmed, colour= Taxa))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.position = "right", 
        legend.direction = "vertical",
        legend.title = element_blank(),
        legend.key.size = unit(0.2, "cm"))+
  labs(y="TL")+
  scale_color_manual(values = lacroix_palette("Tangerine", n=11))+
  ggsave("calculated only.tiff", device = "tiff", dpi = 300, width=7, height =6, units = "cm")

lacroix_palette("Tangerine", n=11)

lacroix_palettes
```

