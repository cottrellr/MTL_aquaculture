---
title: "Production trends"
author: "Richard Cottrell"
date: "10 May 2019"
output: html_document
---

#libraries
```{r}
library(devtools)
# devtools::install_github("johannesbjork/LaCroixColoR")
# remotes::install_github("ropensci/rfishbase")
library(taxize)
library(png)
library(rfishbase)
library(data.table) 
library(mgcv)
library(ggforce)
library(ggpubr)
library(ggsci)
library(ggExtra)
library(ggrepel)
library(purrr)
library(broom)
library(tidyverse)
library(RColorBrewer)
library(LaCroixColoR)
library(countrycode)
library(here)
```

#FED SPP LIST
```{r} 

fed_spp <- 
  fread("data/inputs/fed_spp.csv", header=T) |> 
  rename(Species="Name_en") |>  
  group_by(Species) |> 
  mutate(id = row_number()) 



positions <- c(4:18)

all_spp <- 
  fread("data/inputs/all_spp.csv", header=T) |>  
  rename(Species = "Name_en")|>  
  filter(!(Species %in% fed_spp$Species))


  

```

#Production data
```{r}

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


all_prod <- 
  fread("data/inputs/aqua-prod-raw.csv", header=T) |>  
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")|>  
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) |>  
  mutate(Year = gsub("X", "", Year) |>  
           as.numeric()) |>  
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) |>  
  filter(!(Value=="..." | Value=="" | Country=="Totals")) |>  
  mutate(Value = gsub(" F", "", Value) |>  
           as.numeric()) |> 
  select(-Unit) |>  
  group_by(Country, Species, Area, Year, Environment) |> 
  mutate(id= row_number()) |>  
  filter(Year==2017)


(fed_aqua_prod <- 
  fread("data/inputs/aqua-prod-raw.csv", header=T) |>  
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")|>  
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) |>  
  mutate(Year = gsub("X", "", Year) |>  
           as.numeric()) |>  
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) |>  
  filter(!(Value=="..." | Value=="" | Country=="Totals")) |>  
  mutate(Value = gsub(" F", "", Value) |>  
           as.numeric()) |> 
  select(-Unit) |>  
  group_by(Country, Species, Area, Year, Environment) |> 
  mutate(id= row_number()) |>  
  filter(Species %in% fed_spp$Species) |>  
  left_join(fed_spp, by=c("Species", "id"))|>  
  mutate(Taxa_adj = case_when(Taxa %in% c("Smelts") ~ "Other",
                              Taxa %in% c("Flatfishes","Marine fishes","Cods") ~ "Marine fishes",
                              Species %in% c("Flathead grey mullet" ,"Squaretail mullet",  "So-iuy mullet", "Lebranche mullet" )~ "Mullets",
                              Taxa == "Shrimps" ~ "Shrimps",
                              Taxa == "Carps" ~ "Carps",
                              Taxa == "FW fishes" ~ "FW fishes",
                              Taxa == "FW crustaceans" ~ "FW crustaceans",
                              Taxa == "Marine crustaceans" ~ "Other",
                              Taxa == "Diadromous fishes" ~ "Diadromous fishes",
                              Species=="Milkfish" ~ "Milkfish",
                              Taxa == "Tilapias" ~ "Tilapias",
                              Taxa == "Eels" ~ "Other",
                              Taxa == "Shads" ~ "Other",
                              Taxa == "Tunas" ~ "Other",
                              T ~ Taxa)) |>  
   select(Country, Species, Area, Environment, Year, Value, Group, ISSCAAP_Group, Taxa_adj) |>  
   mutate(Group = case_when(Group == "PISCES" ~ "Fed Finfish",
                            Group == "CRUSTACEA" ~ "Fed Crustaceans")) |>  
   filter(Species!="Silver carp")
   
)



write_csv(fed_aqua_prod, "data/int/Fed_aquaculture.csv")



(unfed_aqua_prod <- 
  fread("aqua-prod-raw.csv", header=T) |>  
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")|>  
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) |>  
  mutate(Year = gsub("X", "", Year) |>  
           as.numeric()) |>  
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "0",
                           T ~ Value)) |>  
  filter(!(Value=="..." | Value==""| Country=="Totals")) |>  
  mutate(Value = gsub(" F", "", Value) |>  
           as.numeric()) |> 
  select(-Unit) |>  
  group_by(Country, Species, Area, Year, Environment) |> 
  mutate(id= row_number()) |>  
  filter(!(Species %in% fed_spp$Species)) |>  
  left_join(all_spp, by="Species") |>  
  select(Country, Species, Area, Environment, Year, Value, Major_Group, ISSCAAP_Group) |>  
  mutate(ISSCAAP_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "Green seaweeds",
                                   Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "Bacteria",
                                   Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "Carps, barbels and other cyprinids",
                                   Species == "[Sargassum spp]" ~ "Brown seaweeds",
                                   Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                  "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                  "[Channa marulius]", "[Labeo dussumieri]",
                                                  "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                  "[Leporinus spp]", "[Leporinus obtusidens]",
                                                  "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                  "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "Miscellaneous freshwater fishes",
                                   Species == "[Solea spp]" ~ "Miscellaneous demersal fishes" ,
                                   Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "Red seaweeds",
                                   TRUE ~ ISSCAAP_Group)) |>  
  mutate(Major_Group = case_when(Species=="[Haematococcus pluvialis]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Spirulina platensis]",  "[Spirulina maxima]") ~ "PROKARYOTA",
                                 Species %in% c("[Carassius spp]", "[Oreochromis tanganicae]" ) ~ "UNFED PISCES",
                                 Species == "[Sargassum spp]" ~ "PLANTAE AQUATICAE",
                                 Species %in% c("[Brycon cephalus]","[Brycon hilarii]", "[Osteobrama belangeri]",
                                                "[Ichthyoelephas humeralis]","[Anostomoides laticeps]", "[Prochilodus mariae]", 
                                                "[Channa marulius]", "[Labeo dussumieri]",
                                                "[Pimelodus spp]" ,"[Brycon amazonicus]", "[Brycon spp]",
                                                "[Leporinus spp]", "[Leporinus obtusidens]",
                                                "[Cichla spp]" , "[Hoplias spp]", "[Hypsibarbus spp]" ,
                                                "[Wallago spp]" ,"[Brycon orbignyanus]" )  ~ "UNFED PISCES",
                                 Species == "[Solea spp]" ~ "UNFED PISCES" ,
                                 Species %in% c("[Porphyra columbina]", "[Chondracanthus chamissoi]" ) ~ "UNFED PISCES",
                                 Major_Group =="PISCES" ~ "UNFED PISCES",
                                 TRUE ~ Major_Group)) |>  
    rename(Group = Major_Group) |>  
    mutate(Group = case_when(Group == "UNFED PISCES" ~ "Unfed finfish",
                             Group == "MOLLUSCA" ~ "Molluscs",
                             Group == "AMPHIBIA, REPTILIA" ~ "Amphibians & reptiles",
                             Group == "PLANTAE AQUATICAE" ~ "Aquatic plants",
                             Group == "PROKARYOTA" ~ "Bacteria",
                             Group == "INVERTEBRATA AQUATICA" ~ "Other aquatic invertebrates",
                             Group == "CRUSTACEA" ~ "Unfed crustaceans" ))
  )                           



(fisheries <- fread("fisheries_prod_raw.csv", header = TRUE) |>  
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Area = `Fishing area (FAO major fishing area)`,
           Unit = `Unit (Unit)`) |>  
    gather(key="Year", value="Value", -c(Country, Species, Area, Unit)) |>  
    mutate(Year = gsub("X", "", Year) |>  
             as.numeric()) |>  
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "0",
                             T ~ Value)) |>  
    filter(!(Value=="..." | Value=="" | Country=="Totals")) |>  
    mutate(Value = gsub(" F", "", Value) |>  
             as.numeric()) |> 
    filter(Unit == "Tonnes - live weight") |>  
    select(-Unit) |>  
    group_by(Year) |>  
    summarise(Value = sum(Value)) |>  
    mutate(Group_2 = "Wild capture") |>  
    select(Group_2, Year, Value)
)


(total_seafood_prod <-
    
    bind_rows(
      bind_rows(
        fed_aqua_prod, unfed_aqua_prod
      ) |> 
        group_by(Group, Year) |> 
        summarise(Value=sum(Value)) |> 
        filter(Group!="Unfed crustaceans") |> 
        ungroup() |> 
        mutate(Group = factor(Group, levels=c("Aquatic plants", "Molluscs", "Bacteria", "Amphibians & reptiles", "Other aquatic invertebrates","Unfed finfish","Fed Crustaceans" , "Fed Finfish"))) |> 
        mutate(Group_2 = case_when(Group %in% c("Fed Crustaceans" , "Fed Finfish",  "Amphibians & reptiles") ~ "Fed aquaculture", 
                                   Group %in% c("Other aquatic invertebrates","Unfed finfish","Bacteria","Aquatic plants", "Molluscs") ~ "Unfed aquaculture")) |> 
        group_by(Group_2, Year) |> 
        summarise(Value=sum(Value)),
      fisheries)
  
)
  
total <- fed_aqua_prod |> 
  filter(grepl("shrimp", Species) & Year == 2017) |>
  group_by(Year) |> 
  summarise(Value = sum(Value))



```

# Figure - Aquaculture production change 

```{r}
#Plot to show fed aquaculture's increasing contribution to seafood production  

# (seafood_compostion <- 
#   ggplot(data = total_seafood_prod, aes(x=Year, y=Value)) + 
#   geom_area(aes(fill=Group_2))+
#   scale_x_continuous(limits=c(1995,2017))+
#   scale_y_continuous(labels = c(0, 50, 100, 150, 200), breaks = c(0,50e+6, 100e+6, 150e+6, 200e+6))+
#   labs(y=bquote(Biomass~(million~tonnes)), fill="All taxa")+
#   theme_pubr()+
#   theme(
#     legend.position = c(0.2, 0.85),
#     legend.title =element_blank(),#  element_text(size = 7, face="bold"),
#     text = element_text(size=8),
#     legend.text = element_text(size=7),
#     legend.key.size = unit(0.4, "cm"),
#     legend.background = element_rect(fill="transparent")
#   )+
#   scale_fill_manual(values =  c("#edf8b1", "#7fcdbb", "#2c7fb8"))+# lacroix_palette("Berry", n=3))+
#   guides(fill= guide_legend(ncol=1)))
#   ggsave("Production trends.tiff", device = "tiff", dpi=300, width=10, height = 7.5, units = "cm")
#   ggsave("Production trends.pdf", device = "pdf", dpi=300, width=10, height = 7.5, units = "cm")

```

#Fed species by biomass 

```{r} 
fed_prod_total <- 
  fed_aqua_prod |>  
  group_by(Year) |>  
  summarise(Value_total=sum(Value))



(fed_prod <- 
  fed_aqua_prod |>  
  group_by(Taxa_adj, Year) |>  
  summarise(Value=sum(Value)) |>  
  mutate(Group_2 = case_when(Taxa_adj %in% c("Carps", "Tilapias") ~ "Herbivores",
                             Taxa_adj %in% c("FW crustaceans", "Catfishes", "Shrimps") ~ "Omnivores",
                             TRUE ~ "Carnivores")) |>  
    group_by(Group_2, Year) |>  
    summarise(Value = sum(Value)) |>  
    left_join(fed_prod_total, by="Year") |>  
    mutate(Prop_total = Value/Value_total))
  
  ggplot(data=fed_prod, aes(x=Year, y=Prop_total, fill=Group_2))+
  geom_area()+
  scale_x_continuous(limits = c(1995,2017))+
  #scale_fill_manual(values = lacroix_palette("Tangerine", n=11))+
  labs(y=bquote(Prop.~global~fed~production), fill="Taxa")+
    theme_pubr()+
    theme(
      legend.position = "right",# c(0.3, 0.76),
      legend.title = element_text(size = 7, face="bold"),
      text = element_text(size=8),
      legend.text = element_text(size=7),
      legend.key.size = unit(0.4, "cm"),
      legend.box.spacing = unit(-0.2, "cm"),
      legend.background = element_rect(fill="transparent")
    )+
  #scale_y_continuous(labels = c(0,10,20,30,40,50))+
    guides(fill= guide_legend(ncol=1))
  ggsave("figures/explore/Fed production trends.tiff", device = "tiff", dpi=300, width=12, height = 7.5, units = "cm")
  ggsave("figures/explore/Fed production trends.pdf", device = "pdf", dpi=300, width=12, height = 7.5, units = "cm")


```


#Trophic levels of different groups

```{r}


fed_aqua_prod_2 <- 
  fed_aqua_prod |> 
  rename(Taxa=Taxa_adj) |> 
  mutate(Taxa=case_when(grepl("eel", Species)~"Eels",
                        TRUE~Taxa)) |> 
  filter(Year>1994) |> 
  mutate(Taxa = case_when(Species == "Milkfish" ~ "Milkfish",
                          ISSCAAP_Group == "Tunas, bonitos, billfishes" ~ "Marine fishes",
                          ISSCAAP_Group %in% c("Miscellaneous diadromous fishes", "Sturgeons, paddlefishes")~"FW fishes",
                          TRUE ~ Taxa)) 


#What proportion of global production is EU - should help guide whether we include animal by products for salmon and trout

totals <- fed_aqua_prod_2 |> 
  group_by(Taxa, Year) |> 
  summarise(Value=sum(Value))



EU <- fed_aqua_prod_2 |> 
  group_by(Country, Taxa, Year) |> 
  summarise(Value=sum(Value)) |> 
  ungroup() |> 
  mutate(Country = case_when(grepl("d'Ivoire", Country) ~ "Ivory Coast",
                             grepl("union", Country) ~ "Reunion",
                             TRUE ~ Country)) |> 
  mutate(EU = countrycode(Country, origin = "country.name", destination = "eu28", warn=FALSE)) |> 
  filter(!is.na(EU) | Country=="Norway") |> 
  ungroup() |> 
  group_by(Taxa, Year) |> 
  summarise(Value=sum(Value)) |>
  left_join(totals, by=c("Taxa", "Year")) |> 
  mutate(Prop=Value.x/Value.y) |> 
  ungroup()


ggplot(EU, aes(x=Year, y=Prop, colour=Taxa)) +
  geom_line()+
  scale_color_futurama()+
  annotate("text", x=2015, y=0.65, label="Salmons")+
  annotate("text", x=2015, y=0.37, label="Trouts")+
  labs(colour="", y="Proportion of global production")+
  theme_pubr()
  ggsave(here("figures/explore/Proportion of global from the EU incl Norway.tiff"), device = "tiff", dpi=300, width = 15, height = 12, units = "cm") 
  ggsave(here("figures/explore/Proportion of global from the EU incl Norway.jpg"), device = "jpg", dpi=300, width = 15, height = 12, units = "cm") #given EU regulations on by-products include Norway - no point using by products in Salmon as EU/Norway accounts for 60% of global production and a ban was in place


#Nis data for trophic level of forage fish


#forage_TL <- fread("forage.fish_TL.csv", header=TRUE) 
  forage_TL <- read_csv(here("data/int/Trophic_level_2020.csv")) |> rename(FMFO_TL=TL)
forage_inclusion <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE)


#Start bringing diet data together

#rendered animal by products from Pahlow
exp_function <- function(x){
  new_data <- data_frame(Year= seq(1995, 2015))
  fit <- lm(log(x$Rendered_animal_prop)~log(x$Year))
  fitted <- exp(predict(fit, newdata = new_data))
  return(fitted)
}

linear_function <- function(x){
  new_data <- data_frame(Year= seq(1995, 2015))
  fit <- lm(x$Rendered_animal_prop~x$Year)
  fitted <- predict(fit, newdata = new_data)
  return(fitted)
}

(animal_parts <- 
    fread(here("data/inputs/diets_pahlow.csv"), header = TRUE) |> 
    group_by(Taxa) |> 
    summarise(Rendered_animal_prop = mean(Prop)) |> 
    mutate(Year=2015))

(by_products <- 
  data_frame(Year = rep(seq(1995, 2015), length(unique(forage_inclusion$Taxa))),
                          Taxa = rep(unique(forage_inclusion$Taxa), each=length(seq(1995,2015)), n=1)) |> 
  left_join(animal_parts, by=c("Taxa", "Year")) |> 
  mutate(Rendered_animal_prop = case_when(Taxa %in% c("Carps", "Eels") & Year %in% c(1995, 2015) ~ 0.00001,
                                          Year == 1995 ~ 0.005,
                                          TRUE ~ Rendered_animal_prop)) |> 
  group_by(Taxa) |> 
    nest() |> 
    mutate(Animal_inclusion = map(data,  exp_function),
           Animal_inclusion_2 = map(data, linear_function)) |> 
    unnest())

#supplementary figure
(by_products_plot <- ggplot(data = by_products |> mutate(Animal_inclusion = case_when(Taxa=="Salmons" ~ 0, 
                                                                                TRUE ~ Animal_inclusion)),
                            aes(Year, y=Animal_inclusion, colour=Taxa))+
  geom_line()+
  scale_color_brewer(type="div", palette = "Spectral")+
  labs(colour="", y="Proportional feed inclusion")+
  theme_pubr())
  ggsave(here("figures/explore/By product inclusion.tiff"), device = "tiff", dpi=300, width = 15, height = 12, units = "cm")
  ggsave(here("figures/explore/By product inclusion.jpg"), device = "jpg", dpi=300, width = 15, height = 12, units = "cm")


#supplementary figure

(forage_fish_TL <- ggplot(data = forage_TL, aes(x=Year, y=FMFO_TL))+
  geom_line()+
   scale_color_brewer(type="div", palette = "Spectral")+
  labs(colour="", y="Mean trophic level")+
  theme_pubr())
  ggsave(here("figures/explore/Forage TL.tiff"), device = "tiff", dpi=300, width = 15, height = 12, units = "cm")
  ggsave(here("figures/explore/Forage TL.jpg"), device = "jpg", dpi=300, width = 15, height = 12, units = "cm")



#MODEL the change in forage fish over all years

total_prod_year <- 
  read_csv(here("data/inputs/forage_fish_diets.csv")) |> 
  mutate(Prod=Prod*1000) |> 
  left_join(totals, by=c("Taxa", "Year")) |> 
  group_by(Year) |> 
  summarise(Total_prod = sum(Value))

total_prod_year_2 <- 
  read_csv(here("data/inputs/forage_fish_diets_2.csv")) |> 
  mutate(Prod=Prod*1000) |>
  left_join(totals, by=c("Taxa", "Year")) |> 
  group_by(Taxa) |> 
  nest() |> 
  mutate(Value = map(data, ~(.$Value[1]))) |> 
  unnest() |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Total_prod = sum(Value1))

total_prod_year_3 <- 
  read_csv(here("data/inputs/forage_fish_diets_3.csv")) |> 
  mutate(Prod=Prod*1000) |> 
  left_join(totals, by=c("Taxa", "Year")) |> 
  group_by(Taxa) |> 
  nest() |> 
  mutate(Value = map(data, ~(.$Value[1]))) |> 
  unnest() |> 
  ungroup() |> 
  group_by(Year) |> 
  summarise(Total_prod = sum(Value1))


total_prod_year_4 <- 
  read_csv(here("data/inputs/forage_fish_diets_4.csv")) |> 
  mutate(Prod=Prod*1000) |> 
  left_join(totals, by=c("Taxa", "Year")) |> 
  group_by(Year) |> 
  summarise(Total_prod = sum(Value))

#with ingredient inclusion, species composition, and forage fish TL all accounted for

aqua_trophic_levels <- 
  bind_rows(
  (TL_delta_global_full <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) |> 
     filter(Year!=2020) |>
     left_join(totals, by=c("Taxa", "Year")) |> 
     left_join(by_products, by=c("Taxa", "Year")) |>
     mutate(FMFO_inclusion=Total/100,
            Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion),
            Feeds_used = Feeds_used*1000,
            Prod = Prod*1000,
            Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) |> 
     left_join(forage_TL, by="Year") |> 
     mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
            Crop_TL = 1, 
            TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
     left_join(total_prod_year, by="Year") |> 
     mutate(MTL = TL_taxon_year*Value/Total_prod) |> 
     group_by(Year) |> 
     summarise(MTL=sum(MTL)) |> 
     mutate(Sensitivity = "All variables")
  ),
  
  (TL_delta_global_FFTL_delta <- fread(here("data/inputs/forage_fish_diets_2.csv"), header=TRUE) |> 
      filter(Year!=2020) |> 
      left_join(by_products, by=c("Taxa", "Year")) |>
     left_join(totals, by=c("Taxa", "Year")) |> 
     group_by(Taxa) |> 
      nest() |> 
      mutate(Value1 = map(data, ~(.$Value[1]))) |> 
      unnest() |> 
      ungroup() |> 
      mutate(FMFO_inclusion=Total/100,
            Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion),
            Feeds_used = Feeds_used*1000,
            Prod = Prod*1000,
            Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) |> 
     left_join(forage_TL, by="Year") |> 
     mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
            Crop_TL = 1, 
            TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
     left_join(total_prod_year_2, by="Year") |> 
      mutate(MTL = TL_taxon_year*Value1/Total_prod) |> 
      group_by(Year) |> 
      summarise(MTL=sum(MTL)) |> 
      mutate(Sensitivity = "FF TL")
  ),
  
  (TL_delta_global_Incl_delta <- fread(here("data/inputs/forage_fish_diets_3.csv"), header=TRUE) |> 
      filter(Year!=2020) |> 
      left_join(by_products, by=c("Taxa", "Year")) |>
     left_join(totals, by=c("Taxa", "Year")) |> 
     group_by(Taxa) |> 
      nest() |> 
      mutate(Value1 = map(data, ~(.$Value[1]))) |> 
      unnest() |> 
      ungroup() |>
      mutate(FMFO_inclusion=Total/100,
             Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion),
             Feeds_used = Feeds_used*1000,
             Prod = Prod*1000,
             Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion),
             Animal_TL = 2.1, #runif(min =2.0, max =  2.1, n=165),
             FMFO_TL = forage_TL$FMFO_TL[forage_TL$Year==1995],
             Crop_TL = 1, 
             TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
      left_join(total_prod_year_3, by="Year") |> 
      mutate(MTL = TL_taxon_year*Value1/Total_prod) |> 
      group_by(Year) |> 
      summarise(MTL=sum(MTL)) |> 
      mutate(Sensitivity = "FF inclusion")
  ),
  
  (TL_delta_global_spp_delta <- fread(here("data/inputs/forage_fish_diets_4.csv"), header=TRUE) |> 
      filter(Year!=2020) |> 
      left_join(by_products, by=c("Taxa", "Year")) |>
     left_join(totals, by=c("Taxa", "Year")) |> 
      mutate(FMFO_inclusion=Total/100,
             Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion),
             Feeds_used = Feeds_used*1000,
             Prod = Prod*1000,
             Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion),
             Animal_TL = 2.1, #runif(min =2.0, max =  2.1, n=165),
             FMFO_TL = forage_TL$FMFO_TL[forage_TL$Year==1995],
             Crop_TL = 1, 
             TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
      left_join(total_prod_year_4, by="Year") |> 
      mutate(MTL = TL_taxon_year*Value/Total_prod) |> 
      group_by(Year) |> 
      summarise(MTL=sum(MTL)) |> 
      mutate(Sensitivity = "Spp. comp")
  )
  
  ) |> write_csv("data/outputs/sector_trophic_levels_sensitivity.csv")


#Repeat the all variables but with linear animal-byproduct inclusion for senitivity analysis

aqua_trophic_levels_linears_LAPS <- 
  bind_rows(
  (exponential <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) |> 
     filter(Year!=2020) |> 
     left_join(by_products, by=c("Taxa", "Year")) |>
     left_join(totals, by=c("Taxa", "Year")) |>
     mutate(FMFO_inclusion=Total/100,
            Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                         TRUE ~ Animal_inclusion),
            Feeds_used = Feeds_used*1000,
            Prod = Prod*1000,
            Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) |> 
     left_join(forage_TL, by="Year") |> 
     mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
            Crop_TL = 1, 
            TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
     left_join(total_prod_year, by="Year") |> 
     mutate(MTL = TL_taxon_year*Value/Total_prod) |> 
     group_by(Year) |> 
     summarise(MTL=sum(MTL)) |> 
     mutate(Sensitivity = "Exponential")
  ),
  
  (linear <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) |> 
    filter(Year!=2020) |> 
    left_join(by_products, by=c("Taxa", "Year")) |>
    left_join(totals, by=c("Taxa", "Year")) |>
    mutate(FMFO_inclusion=Total/100,
           Animal_inclusion_2 = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion_2),
           Feeds_used = Feeds_used*1000,
           Prod = Prod*1000,
           Crop_inclusion = 1-(Animal_inclusion_2+FMFO_inclusion)) |> 
    left_join(forage_TL, by="Year") |> 
    mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
           Crop_TL = 1, 
           TL_taxon_year = (Animal_inclusion_2*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
    left_join(total_prod_year, by="Year") |> 
    mutate(MTL = TL_taxon_year*Value/Total_prod) |> 
    group_by(Year) |> 
    summarise(MTL=sum(MTL)) |> 
    mutate(Sensitivity = "Linear")
   ),
  
   
   (sal_byp <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) |> 
     filter(Year!=2020) |> 
    left_join(by_products, by=c("Taxa", "Year")) |>
    left_join(totals, by=c("Taxa", "Year")) |>
    mutate(FMFO_inclusion=Total/100,
           # Animal_inclusion_2 = case_when(Taxa == "Salmons" ~ 0,
           #                                TRUE ~ Animal_inclusion_2),
           Feeds_used = Feeds_used*1000,
           Prod = Prod*1000,
           Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) |> 
    left_join(forage_TL, by="Year") |> 
    mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
           Crop_TL = 1, 
           TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) |> 
    left_join(total_prod_year, by="Year") |> 
    mutate(MTL = TL_taxon_year*Value/Total_prod) |> 
    group_by(Year) |> 
    summarise(MTL=sum(MTL)) |> 
    mutate(Sensitivity = "Salmon w/ by-product")
)
) |> 
  write_csv(file = "data/outputs/sector_trophic_levels_sensitivity_linearLAPInclusion.csv")  

  ggplot(data = aqua_trophic_levels_linears_LAPS, aes(x=Year, y=MTL, colour=Sensitivity))+geom_line()+
  theme_pubr()+
  theme(legend.title = element_blank())+
  labs(y="Mean trophic Level", colour = "Animal by-product inclusion")+
  scale_color_aaas()+
  guides(colour = guide_legend(title.position = "top", title.hjust = .5))
  ggsave(here("figures/Figure S2 - by product sensitivity.jpg"), device = "jpg", dpi=300, width=12, height = 10, units="cm")
  ggsave(here("figures/Figure S2 - by product sensitivity.pdf"), device = "pdf", dpi=300, width=12, height = 10, units="cm")
  
```


#Figure - Diet change and MTL sensitivity

```{r}

MTL_sensitivity <- 
  ggplot(aqua_trophic_levels, aes(x=Year, y=MTL, colour=Sensitivity))+
  geom_line(size=1)+
  theme_pubr()+
  theme(
    legend.position = "right",
    text = element_text(size=10),
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.box.spacing = unit(-0.4, "cm")
    )+
  scale_y_continuous(limits = c(2,2.7))+
  scale_color_manual(values = c(rev(lacroix_palette("Pamplemousse", n=10))[c(1,3,5,10)]), name = bquote(Allow~change~to))+
  labs(y="Mean effective trophic level")
  ggsave("figures/MTL_global_fed_aquaculture.tiff", device = "tiff", dpi=600, width = 9, height = 6, units="cm")
  ggsave("figures/MTL_global_fed_aquaculture.pdf", device = "pdf", dpi=600, width = 9, height = 6, units="cm")





salmon_diet <- data_frame(Year=rep(c("1990", "2000", "2016"), each=6, times=1),
                          Ingredient = rep(c("Marine protein", "Marine oils", "Plant protein", "Plant oil", "Carbohydrates", "Microingredients"),times=3),
                          Inclusion = c(65.4, 24, 0, 0, 9.5, 1, 33.5, 31.1, 22.2, 0, 11.2, 2.0, 14.5, 10.4, 40.3, 20.2, 10.6, 4))

anchovy <- readPNG("figures/icons/Anchovy-engraulis_anchoita_el.png")
anchovy <- grid::rasterGrob(anchovy)

soy <- readPNG("figures/icons/ian-symbol-soybeans.png")
soy <- grid::rasterGrob(soy)

micro <- readPNG("figures/icons/black-pepper.png")
micro <- grid::rasterGrob(micro)

salmon_diet_plot <- 
  ggplot(salmon_diet %>% mutate(Ingredient = factor(Ingredient, levels = rev(c("Marine protein", "Marine oils", "Plant protein", "Plant oil", "Carbohydrates", "Microingredients")))), aes(x=Year, y = Inclusion, fill = Ingredient))+
  geom_bar(stat="identity", width = 0.5)+
  theme_pubr()+
  theme(
    text = element_text(size=10),
    legend.position = "right", 
    legend.background  = element_rect(fill="transparent"),
    legend.key = element_blank(),
    legend.box.spacing = unit(-0.3, "cm"),
    legend.title = element_blank(),
    legend.text = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    axis.title.x = element_blank(),
    plot.background = element_rect(fill="transparent", colour="transparent"),
    axis.text.x = element_text(hjust = 1, angle = 45)
    
  )+ 
  #guides(fill=FALSE)+
  scale_fill_manual(values = (lacroix_palette("Lemon", n=6)))+#   rev(c("dodgerblue4", "dodgerblue2", "seagreen4", "seagreen3", "seagreen2", "goldenrod")))+
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))+
  # annotation_custom(anchovy, xmin = c(0.7), xmax = c(1.3), ymin = c(62), ymax=c(68))+
  # annotation_custom(anchovy,  xmin = c(1.8), xmax = c(2.2), ymin = c(31), ymax=c(37))+
  # annotation_custom(anchovy, xmin = c(2.85), xmax = c(3.15), ymin = c(12), ymax=c(17))+
  # annotation_custom(soy,  xmin = c(0.85), xmax = c(1.15), ymin = c(91), ymax=c(98))+
  # annotation_custom(soy,  xmin = c(1.85), xmax = c(2.15), ymin = c(70), ymax=c(97))+
  # annotation_custom(soy, xmin = c(2.8), xmax = c(3.2), ymin = c(30), ymax=c(97))+
  # annotation_custom(micro,  xmin = c(1.85), xmax = c(2.15), ymin = c(98), ymax=c(99.6))+
  # annotation_custom(micro, xmin = c(2.8), xmax = c(3.2), ymin = c(96.5), ymax=c(99.6))+
  # annotate("segment", 
  #          x = c(1.25, 1.25, 1.25, 2.25, 2.25, 2.25), 
  #          xend = c( 1.75, 1.75, 1.75, 2.75, 2.75, 2.75), 
  #          y = c(89.4, 98.9, 100, 64.6, 98, 100), 
  #          yend = c(64.6, 98, 100, 24.9, 96, 100), 
  #          linetype = 1, size=0.1, colour="grey50")+
  labs(y="Feed composition (%)")
  ggsave("figures/diet_comp_salmon.pdf", device = "pdf", dpi=600, width = 9, height = 6, units="cm")
  ggsave("figures/diet_comp_salmon.tiff", device = "tiff", dpi=600, width = 9, height = 6, units="cm")


#put salmon diet inset and export plot

MTL_sensitivity+
    annotation_custom(grob = ggplotGrob(salmon_diet_plot), 
                                  xmin = 1994.5,
                                  xmax = 2007,
                                  ymin = 1.975,
                                  ymax = 2.35)
  ggsave("figures/Figure - diet and MTL sensitivity_2.tiff", device ="tiff", dpi=600, width = 15, height= 10, units = "cm")
  ggsave("figures/Figure - diet and MTL sensitivity_2.pdf", device ="pdf", dpi=600, width = 15, height= 10, units = "cm")
  ggsave("figures/Figure - diet and MTL sensitivity_2.jpg", device ="jpg", dpi=600, width = 15, height= 10, units = "cm")

``` 


# Taxa trends relative to fishbase

Some problems with rfishbase accessing sealifebase at present (25 Apr 23) so commented to allow smooth access to aquaculture TLs.
```{r}
#top species by producton - will use the top 10 species unless 90% of production is not reached
# marine_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Marine fishes" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   #filter(!cum_prop>.91) %>% 
#   slice(1:11) %>% 
#   .$Species
# 
# catfish_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Catfishes" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# trout_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Trouts" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# tilapia_sp <- 
#   fed_aqua_prod %>% 
#   filter(Taxa_adj=="Tilapias" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# carp_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Carps" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# 
# fw_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="FW fishes" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# salmon_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Salmons" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# 
# shrimp_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="Shrimps" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# 
# crust_sp <- fed_aqua_prod %>% 
#   filter(Taxa_adj=="FW crustaceans" & Year ==2017) %>% 
#   group_by(Species) %>% 
#   summarise(value=sum(Value)) %>% 
#   arrange(-value) %>% 
#   filter(!grepl("nei", Species)) %>% 
#   mutate(prop = value/sum(value),
#          cum_prop= cumsum(prop)) %>% 
#   slice(1:10) %>% 
#   .$Species
# 
# #identify species in fishbase and sealifebase
# (salmons <- common_to_sci(c("Atlantic salmon", "Coho salmon", "Chinook salmon")) %>% slice(1,4,5))
# (trouts <- rfishbase::common_to_sci(c("Rainbow trout", "Clearhead icefish", "Brown trout", "BrookTrout")) %>% slice(3,4,5))
# (carps <- rfishbase::common_to_sci(carp_sp) %>% slice(1,5,6,8,11,17,18,19,20))
# (tilapias <- rfishbase::common_to_sci(tilapia_sp) %>% slice(1,3,4,7,8,1,12,13,14))
# (catfishes <- rfishbase::common_to_sci(c(catfish_sp)) %>% slice(5,10,14:25))
# (marine_fishes <- rfishbase::common_to_sci(c(marine_sp)) %>% slice(1:4,7,8,10,12,34,61,66))
# (fw_fishes <- rfishbase::common_to_sci(c(fw_sp)) %>% slice(2,46,47,51,52,54,57,67,71,89))
# (eels <- rfishbase::common_to_sci(c("Eel")) %>% filter(grepl("Anguilla", Species)))
# (shrimps <- common_to_sci(c(shrimp_sp),  server = "sealifebase") %>% slice(1,2,3,6,8,12,15,17,18))
# (fw_crusts <- common_to_sci(c(crust_sp),  server = "sealifebase") %>%
#     drop_na(Species))
# 
# 
# (Fishbase_TLs <-
#     bind_rows(
#       
#       (Salmons <-  ecology(salmons$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Salmons")),
#       
#       
#       (Trouts <- rfishbase::ecology(trouts$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Trouts")),
#       
#       
#       (Carps <- rfishbase::ecology(carps$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Carps")),
#       
#       
#       
#       (Tilapias <- rfishbase::ecology(tilapias$Species) %>%
#          select(Species,DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Tilapias")),
#       
#       
#       (Catfishes <- rfishbase::ecology(catfishes$Species) %>%
#          select(Species, DietTroph,  FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Catfishes")),
#       
#       
#       (Milkfish <- rfishbase::ecology("Chanos chanos") %>%
#          select(Species, DietTroph,  FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Milkfish")),
#       
#       
#       
#       (Marine_fishes <- ecology(marine_fishes$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa="Marine fishes")),
#       
#       
#       (FW_fishes <- rfishbase::ecology(fw_fishes$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Spp = case_when(grepl("hanna", Species) ~ "Snakehead",
#                                 TRUE ~ "Blackmouth bass"),
#                 FoodTroph = as.numeric(FoodTroph)) %>%
#          group_by(Spp) %>%
#          summarise(FoodTroph=mean(FoodTroph)) %>%
#          mutate(DietTroph = c(3.84, 4.44),
#                 Species=Spp) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          # mutate(DietTroph = as.character(DietTroph),
#          #        FoodTroph = as.character(FoodTroph)) %>%
#          mutate(Taxa = "FW fishes")),
#       
#       (Eels <- rfishbase::ecology(eels$Species) %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          mutate(Taxa="Eels")),
#       
#       
#       (Shrimps <- rfishbase::ecology(shrimps$Species, server = "sealifebase") %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa = "Shrimps")),
#       
#       
#       
#       (FW_crusts <- ecology(fw_crusts$Species, server = "sealifebase") %>%
#          select(Species, DietTroph, FoodTroph) %>%
#          filter(!(is.na(DietTroph) & is.na(FoodTroph))) %>%
#          mutate(Taxa = "FW crustaceans"))
#     ) %>%
#     mutate(TL_final = case_when(!is.na(DietTroph)~ DietTroph,
#                                 TRUE ~ FoodTroph),
#            TL_final = as.numeric(TL_final)) %>%
#     distinct() %>% 
#     drop_na(TL_final) %>% 
#     group_by(Species, Taxa) %>% 
#     summarise(TL_final=mean(TL_final)) %>% 
#     arrange(Taxa)#%>% 
#     #group_by(Taxa) %>%
#     # summarise(median = median(TL_final),
#     #           lower = quantile(TL_final,0.05),
#     #           upper = quantile(TL_final,0.95))
# )
# 
# 
# write_csv(Fishbase_TLs, here("Table - Fishbase TLs.csv"))
#
```


#Figure  - Temporal trends in effective trophic level
```{r}


# 
# # boxplot inset plots
# 
# (carp_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Carps"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#   theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.5), expand = c(0,0))
#   
# )
# 
# 
# 
# 
# (catfish_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Catfishes"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#    theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.7), expand = c(0,0))
#   
# )
# 
# 
# (eel_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Eels"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#   theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.7), expand = c(0,0))
#   
# )
# 
# (crust_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="FW crustaceans"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#      theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,3.2), expand = c(0,0))
#   
# )
# 
# (FW_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="FW fishes"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#      theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.7), expand = c(0,0))
#   
#   
# )
# 
# (marine_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Marine fishes"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
# theme(
#   panel.background = element_rect(fill="transparent", colour = "transparent"),
#   panel.grid = element_blank(),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.5), expand = c(0,0))
#   
# )
# 
# (milk_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Milkfish"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#   theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,2.7), expand = c(0,0))
#     
#   
# )
# 
# (salm_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Salmons"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#  theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.7), expand = c(0,0))
#   
# )
# 
# 
# (shrimp_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Shrimps"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#   theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.2), expand = c(0,0))
#   
# )
# 
# 
# (tilapia_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Tilapias"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#   theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,3), expand = c(0,0))
#   
# )
# 
# (trout_wild <- ggplot(Fishbase_TLs %>% filter(Taxa =="Trouts"))+
#   geom_boxplot(aes(y=TL_final, middle=median(TL_final), lower=quantile(TL_final,0.95), upper=quantile(TL_final,0.95)), fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#  theme(panel.background = element_rect(fill="transparent", colour = "transparent"),
#         plot.background = element_rect(fill="transparent", colour="transparent"),
#         rect = element_rect(fill = "transparent", colour = "transparent"),
#         axis.text.x = element_blank(),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         axis.ticks =element_blank(),
#         element_blank(),
#         plot.margin = unit(c(0,0,0,0), "cm"))+
# scale_y_continuous(limits = c(2,4.4), expand = c(0,0))
#   
# )




(TL_taxa <- fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) %>% 
     filter(Year!=2020) %>% 
    left_join(totals, by=c("Taxa", "Year")) %>% 
     left_join(by_products, by=c("Taxa", "Year")) %>%
     mutate(FMFO_inclusion=Total/100,
            Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                          TRUE ~ Animal_inclusion),
            Feeds_used = Feeds_used*1000,
            Prod = Prod*1000,
            Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) %>% 
     left_join(forage_TL, by="Year") %>% 
     mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
            Crop_TL = 1, 
            TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) %>% 
     left_join(total_prod_year, by="Year") %>% 
     mutate(MTL = TL_taxon_year*Value/Total_prod))

#export data for tl for all species
TL_taxa_export <- 
  TL_taxa |> select(Taxa,Year, Animal_inclusion, FMFO_inclusion,Crop_inclusion, Animal_TL, FMFO_TL, Crop_TL, TL_taxon_year) |> 
  write_csv("data/outputs/taxon_TLs.csv")




# #main plots
# 
# (carp_plot <- ggplot(TL_taxa %>% filter(Taxa=="Carps"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,3.5))+
#   annotate("text", x=2005, y=3.5, label="(8)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(carp_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=3.5)+
#   theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Carps"))#+
#   #annotation_custom(carp_png, xmin = 2011,xmax=2015, ymin = 3.4,ymax=3.6 ))
#   
# 
# 
# (catfish_plot <- ggplot(TL_taxa %>% filter(Taxa=="Catfishes"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.7), breaks = c(2,2.5,3,3.5,4,4.5))+
#   annotate("text", x=2005, y=4.7, label="(10)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(catfish_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.7)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Catfishes"))#+
#   #annotation_custom(catfish_png, xmin = 2012, xmax=2016, ymin = 4.5,ymax=4.8 ))
#   
#   
# 
# eel_plot <- ggplot(TL_taxa %>% filter(Taxa=="Eels"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.7), breaks = c(2,2.5,3,3.5,4,4.5))+
#   annotate("text", x=2005, y=4.7, label="(11)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(eel_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.7)+
#   theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Eels")#+
#  # annotation_custom(eel_png, xmin = 2012, xmax=2015, ymin = 4.5,ymax=4.8 )
#   
# 
# 
# crust_plot <- ggplot(TL_taxa %>% filter(Taxa=="FW crustaceans"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,3.2), breaks=c(2.0, 2.25, 2.5, 2.75,3))+
#   annotate("text", x=2005, y=3.2, label="(2)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(crust_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=3.2)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "FW crustaceans")#+
#   #annotation_custom(crust_png, xmin = 2009, xmax=2015, ymin = 3.02,ymax=3.32 )
#   
# 
# fw_plot <- ggplot(TL_taxa %>% filter(Taxa=="FW fishes"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.7), breaks = c(2,2.5,3.0,3.5,4.0,4.5), labels =c(2,2.5,3.0,3.5,4.0,4.5))+
#   annotate("text", x=2005, y=4.7, label="(2)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(FW_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.7)+
#   theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Other FW fishes")#+
#   #annotation_custom(freshfish_png, xmin = 2011, xmax=2015, ymin = 4.42,ymax=4.72)
#   
# 
# 
# (marine_plot <- ggplot(TL_taxa %>% filter(Taxa=="Marine fishes"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.8), breaks = c(2,2.5,3.0,3.5,4.0,4.5), labels = c(2,2.5,3.0,3.5,4.0,4.5))+
#     annotate("text", x=2001, y=4.8, label="(11)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(marine_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.8)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Marine fishes"))#+
#   #annotation_custom(marine_png, xmin = 2011, xmax=2015, ymin = 4.57,ymax=4.82))
#   
# 
# 
# milk_plot <- ggplot(TL_taxa %>% filter(Taxa=="Milkfish"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,2.7), breaks = c(2,2.2,2.4,2.6))+
#   annotate("text", x=2005, y=2.7, label="(1)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(milk_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=2.7)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Milkfish")#+
#   #annotation_custom(milk_png, xmin = 2010, xmax=2015, ymin = 2.62,ymax=2.72 )
#   
# 
# 
# salm_plot <- ggplot(TL_taxa %>% filter(Taxa=="Salmons"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.7), breaks = c(2,2.5,3,3.5,4,4.5))+
#   annotate("text", x=2005, y=4.7, label="(3)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(salm_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.7)+
#   theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Salmons")#+
#   #annotation_custom(salmon_png, xmin = 2010, xmax=2015, ymin = 4.48,ymax=4.78 )
#   
# 
# shrimp_plot <- ggplot(TL_taxa %>% filter(Taxa=="Shrimps"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.2))+
#   annotate("text", x=2005, y=4.2, label="(6)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(shrimp_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.2)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Shrimps")#+
#   #annotation_custom(shrimp_png, xmin = 2010, xmax=2015, ymin = 4,ymax=4.3 )
#   
# 
# 
# tilapia_plot <- ggplot(TL_taxa %>% filter(Taxa=="Tilapias"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,3))+
#   annotate("text", x=2005, y=3, label="(8)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(tilapia_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=3)+
#  theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Tilapias")#+
#   #annotation_custom(tilapia_png, xmin = 2010, xmax=2015, ymin = 2.85,ymax=3.1 )
#   
# 
# trout_plot <- ggplot(TL_taxa %>% filter(Taxa=="Trouts"), aes(x=Year, y=TL_taxon_year))+geom_line(colour=lacroix_palette("Lemon", n=10)[10])+
#   scale_y_continuous(limits=c(2,4.4))+
#   annotate("text", x=2005, y=4.4, label="(2)", size=2.7)+
#   annotation_custom(grob=ggplotGrob(trout_wild),
#                     xmin = 2002,
#                     xmax = 2008,
#                     ymin = 2,
#                     ymax=4.4)+
#   theme_pubr()+
#   theme(axis.title = element_blank(),
#         axis.text.x = element_text(size=9, angle = 45, hjust=1),
#         plot.subtitle = element_text(size=9))+
#   labs(subtitle = "Trouts")#+
#   #annotation_custom(trout_png, xmin = 2011, xmax=2015, ymin = 4.2,ymax=4.5 )
#   
# 
# (legend_plot <- ggplot()+theme(rect = element_blank())+
#     theme(axis.text = element_blank(),
#           axis.title = element_blank(),
#           axis.ticks = element_blank())+
#     scale_x_continuous(limits=c(0,1))+
#     scale_y_continuous(limits=c(0,1))+
#   annotate("segment", x=0.1, xend = 0.3, y=0.4, yend=0.4, color=lacroix_palette("Lemon", n=10)[7])+
#     annotate("segment", x=0.1, xend = 0.3, y=0.75, yend=0.75, color=lacroix_palette("Lemon", n=10)[10])+
#     annotate("rect", xmin = 0.1, xmax = 0.3, ymin = 0.3, ymax=0.5, fill="transparent", colour=lacroix_palette("Lemon", n=10)[7])+
#     annotate("text", y=0.75, x=0.4, label = "Mean\neffective\n(farmed)", size=2.8, hjust=0)+
#     annotate("text", y=0.4, x=0.4, label = "Wild", size=2.8, hjust=0)
# )
# 
# 
# 
# annotate_figure(p = ggarrange(carp_plot, catfish_plot, eel_plot, crust_plot,
#           fw_plot, marine_plot, milk_plot, salm_plot,
#           shrimp_plot, tilapia_plot, trout_plot, legend_plot,
#           nrow=3,
#           ncol=4
#           ),
#           left = text_grob("Trophic level", size=11, rot = 90),
#           bottom = text_grob("Year", size=11))+
#   ggsave("figures/Figure Fishbase_v_calculated_2.tiff", device = "tiff", dpi = 300, width=15, height = 18, units = "cm")
#    ggsave("figures/Figure - Fishbase_v_calculated_2.jpg", device = "jpg", dpi = 300, width=15, height = 18, units = "cm")
#   ggsave("figures/Figure - Fishbase_v_calculated_2.pdf", device = "pdf", dpi = 300, width=15, height = 18, units = "cm")
# 
# 
# 
#   

```

  
#Figure - clustering of trophic level across taxa
```{r}

FCRs <- fread(here("data/inputs/eFCRs.csv"), header=TRUE)


(trophic_levels <- 
  fread(here("data/inputs/forage_fish_diets.csv"), header=TRUE) %>% 
  filter(Year!=2020) %>% 
  left_join(totals, by=c("Taxa", "Year")) %>%
  left_join(by_products, by=c("Taxa", "Year")) %>%
  mutate(FMFO_inclusion=Total/100,
         Animal_inclusion = case_when(Taxa == "Salmons" ~ 0,
                                      TRUE ~ Animal_inclusion),
         Feeds_used = Feeds_used*1000,
         Prod = Prod*1000,
         Crop_inclusion = 1-(Animal_inclusion+FMFO_inclusion)) %>% 
  left_join(forage_TL, by="Year") %>% 
  mutate(Animal_TL = 2.1,# runif(min =2.0, max =  2.1, n=165),
         Crop_TL = 1, 
         TL_taxon_year = (Animal_inclusion*Animal_TL)+ (FMFO_inclusion*FMFO_TL) + (Crop_inclusion*Crop_TL)+1) %>% 
  left_join(total_prod_year, by="Year") %>% 
  mutate(MTL = TL_taxon_year*Value/Total_prod) %>% 
    left_join(FCRs, by=c("Taxa", "Year"))
)



(TL_FCR_plot <- ggplot(trophic_levels %>% filter(Year %in% c(1995, 2005, 2015) & !Taxa %in%c("FW fishes", "Milkfish")) %>% mutate(Year= factor(Year, levels = (c("1995", "2005",  "2015")))), 
       aes(x=TL_taxon_year, y=eFCR, colour=Year))+
    geom_point(size=1.5)+
  geom_line(data= trophic_levels %>% filter(Year %in% c(1995, 2005, 2015)) %>% mutate(Year = factor(Year, levels=c("1995", "2005", "2015"))) %>% filter(Taxa %in% c("Tilapias", "Carps", "Shrimps",  "Salmons", "Marine fishes" , "Eels", "Trouts", "FW crustaceans")) , aes(group=Taxa, x=TL_taxon_year, y=eFCR), colour="black", linetype=3)+
  
  geom_mark_ellipse(aes(fill=Year), colour=NA)+
  scale_x_continuous(limits = c(1.9,3.7))+
  scale_y_continuous(limits = c(1.2, 2.6))+
  theme_pubr()+
  geom_text(data = trophic_levels %>%
                    filter(Year %in% c(1995, 2015) & Taxa %in% c("Tilapias", "Carps", "Shrimps", "Salmons", "Marine fishes", "Eels", "Trouts", "FW crustaceans", "Catfishes")) %>% 
                    mutate(Year= factor(Year, levels = (c("1995", "2015"))),
                           Taxa=case_when(Taxa=="Tilapias" ~ "Tilapia",
                                          Taxa=="Salmons" ~ "Salmon",
                                          TRUE ~ Taxa)),
                  mapping = aes(label=Taxa), 
                  colour="black", 
                  size=2.5, 
                  segment.size = 0.2, 
                  nudge_x = c(0,-0.06, 0, -0.06, 0, 0.05,0,0.05,0,-0.05, 0,-0.05,-0.06, -0.05 , 0,-0.05, 0,0.15),
                  nudge_y = c(0.05,-0.05,0.05,-0.05, 0.05, -0.05,0.05,-0.05,0.05,-0.05,0.05,-0.05,0.05,-0.05, 0.05,-0.02, 0.05, -0.05),
                  force = 0.7,
                  point.padding = 0.5)+
    geom_segment(x= 2.132447, xend = 2.301294, y=2.0, yend=1.6, colour="grey40", linetype=3)+
    geom_segment(x=2.301294, xend = 2.131350, y=1.6, yend=1.4, colour="grey40", linetype=3)+
    
  # geom_curve(x=c(2.38), xend = c(2.0864), y= c(2.0), yend=c(1.72), curvature = 0.09, arrow = arrow(type = "open", angle = 35, length = unit(0.1, "cm")), colour="grey50", size=0.4)+
  # geom_curve(x=c(3.48), xend = c(2.66), y= c(1.48), yend=c(1.29), curvature = -0.4, arrow = arrow(type = "open", angle = 35, length = unit(0.1, "cm")), colour="grey50", size=0.4)+
  theme(legend.position = c(0.9,0.9),
        text = element_text(size=10),
        legend.box.spacing = unit(0.2, "cm"),
        legend.key.size = unit(0.3, "cm"), 
        legend.key = element_rect(colour = "white"),
        legend.title = element_blank())+
  scale_fill_manual(values = c((lacroix_palette("Lemon", n=10))[c(3,7,10)]))+
  scale_colour_manual(values = c((lacroix_palette("Lemon", n=10))[c(3,7,10)]))+
  labs(y="Feed conversion ratio", x="Trophic level"))



ggsave( "figures/Figure - FCR vs TL.jpg", ggMarginal(TL_FCR_plot, groupColour = TRUE, groupFill = TRUE, xparams = list( size=1), yparams = list(size=1)), device = "jpg", dpi=600, width = 18, height = 13, units = "cm")

ggsave( "figures/Figure - FCR vs TL.pdf", ggMarginal(TL_FCR_plot, groupColour = TRUE, groupFill = TRUE, xparams = list( size=1), yparams = list(size=1)), device = "pdf", dpi=600, width = 18, height = 13, units = "cm")



```


#Figure - map of change in seafood demand

```{r}

food_bal <- vroom::vroom(file = file.path("", "home", "shares","clean-seafood", "data", "bottlenecks_data", "FAO", "food_balances", "food_balance_tidy.csv"), delim = ",")

(food_supp <- food_bal |> 
  mutate(area = case_when(grepl("d'Ivoire", area) ~ "Cote d'Ivoire",
                          TRUE ~ area)) |> 
  filter(element=="Food supply quantity (kg/capita/yr)" & item== "Fish, Seafood" & year %in% c(1993, 2013) & area!="China") |> 
  mutate(iso_a3 = countrycode(area, origin="country.name", destination = "iso3c", warn=TRUE)) |> 
  drop_na(iso_a3) |> 
  group_by(iso_a3, area) |> 
  summarise(delta_fish_supply = diff(quantity)) |> 
  drop_na(delta_fish_supply)
)


#bounding box
bbox <- readOGR(dsn=file.path(here("Shapefiles", "ne_110m_graticules_all")), layer="ne_110m_wgs84_bounding_box")

bbox <- spTransform(bbox, CRS("+proj=moll"))  # reproject bounding box
bbox_df<- fortify(bbox) #, group="ISO_TER1"


#countries
countries <- readOGR(dsn = file.path(here("Shapefiles", "ne_110m_admin_0_countries")), layer="ne_110m_admin_0_countries")
#countries <- countries[!countries$iso_a3 %in% c("ATA"),] #remove antartica
countries<- spTransform(countries, CRS("+proj=moll"))
countries@data$id <- rownames(countries@data)
countries@data <- left_join(countries@data, food_supp, by="iso_a3")
countries_df<-fortify(countries)
countries_df<-left_join(countries_df, countries@data, by="id")


(map <- ggplot(data=bbox_df, aes(long,lat, group=group)) + geom_polygon(fill="aliceblue")+
  geom_polygon(data=countries_df, aes(x=long, y=lat, group=group,  fill=(delta_fish_supply)), colour="grey40", size=0.3)+
  theme_nothing()+
  theme(legend.position = "bottom",
        legend.text = element_text(size=8),
        legend.title = element_text(size=8),
        legend.box.spacing = unit(0, "cm"))+
  #scale_fill_viridis_c(direction=-1, option="C", na.value = "grey90",labels=c(2.5, 5, 7.5, 10), breaks=c(2.5e+08, 5e+08, 7.5e+08, 10e+08))+
    scale_fill_gradient2(low = "yellow", mid = "violetred3", high = "orchid4", midpoint = 10, na.value = "grey90")+
  guides(fill=guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = 15, barheight = 0.5, units="cm"))+
  labs(fill=bquote(Change~"in"~fish~supply~1993-2013~(kg~capita^-1~year^-1))) +
  ggsave(here(paste0("seafood supply map_", Sys.Date(), ".jpg")), device="jpg", dpi=300, width=12, height=8, units="cm")+
  ggsave(here(paste0("seafood supply map_", Sys.Date(), ".pdf")), device="pdf", dpi=300, width=12, height=8, units="cm"))

```




